name: i18n Consistency Check

on:
  pull_request:
    branches:
      - master
    paths:
      - .github/workflows/i18n-consistency-check.yml
  schedule:
    - cron: '0 0 1 * *'  # run at midnight, on day 1 of the month
  workflow_dispatch:

jobs:
  consistency-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [ja, zh]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: '0'
      - name: Check consistency and create issue
        id: check-consistency
        run: |
          # Set the issue header
          issue_header=$(cat <<- EOM
            # i18n Contents Consistency Issue

            The following files may have consistency issues with the English version. Please check and update the files.

            This issue is created when there is an update to content/en. It compares the git update history to let you know what updates are overdue. The issue should be closed when the update is complete.
          EOM
          )

          # Loop through all the files in the English directory
          for file in \$(find patterns/2-structured -name '*.md'); do
            # Rest of the code for consistency check
            
            # If issues found, append to a temporary issue file
            if [ <issue_condition> ]; then
              issue_content=$(cat <<- EOM
                <details>
                <summary><b>\$content_title</b> (\$file)</summary>

                - Original File(en): [\$file](https://github.com/\$GITHUB_REPOSITORY/blob/master/\$file)
                - Translated File(\${{matrix.language}}): [\$i18n_filename](https://github.com/\$GITHUB_REPOSITORY/blob/master/\$i18n_filename)
                - [Diff on GitHub](https://github.com/\$GITHUB_REPOSITORY/compare/\$i18n_last_update_hash...\$original_last_update_hash)
                - Days since overdue updates: \$days_since_overdue_updates days

                \`\`\`diff
                \$result
                \`\`\`
                </details>
              EOM
              )

              echo "\$issue_content" >> issue.md
            fi
          done

          # Create the issue or comment on the existing one
          flags=(
            ["ja"]="ðŸ‡¯ðŸ‡µ Japanese"
            ["zh"]="ðŸ‡¨ðŸ‡³ Chinese"
          )
          issue_title="\${flags[\${{matrix.language}}]}: Content Consistency Issue"
          existing_issue_id=\$(gh issue list -S "state:open type:issue title:\$issue_title" | cut -f1)

          if [ -f issue.md ]; then
            if expr "\$existing_issue_id" : '^[0-9]*$' >/dev/null; then
              gh issue comment "\$existing_issue_id" -F issue.md -R \$GITHUB_REPOSITORY
            else
              gh issue create -t "\$issue_title" -F issue.md -R \$GITHUB_REPOSITORY -l "Type - Translation"
            fi
          fi
        env:
          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}